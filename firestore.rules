rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isOwnerOrAdmin(userId) {
      return isOwner(userId) || isAdmin();
    }

    // Prevent tampering with protected fields
    function notUpdatingProtectedFields(protectedFields) {
      return !request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(protectedFields);
    }

    // Validate timestamps exist
    function hasValidTimestamps() {
      return request.resource.data.keys().hasAll(['createdAt', 'updatedAt']);
    }

    // Validate required fields exist
    function hasRequiredFields(fields) {
      return request.resource.data.keys().hasAll(fields);
    }

    // ==================== BOOKINGS ====================

    match /bookings/{bookingId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'flightDetails', 'passengerInfo',
                          'totalPrice', 'currency', 'status', 'paymentStatus']) &&
        hasValidTimestamps() &&
        request.resource.data.status in ['pending', 'confirmed'] &&
        request.resource.data.paymentStatus in ['pending', 'paid'] &&
        request.resource.data.totalPrice > 0;

      allow update: if isAdmin() &&
        // Can't change userId or financial data after payment
        (resource.data.paymentStatus != 'paid' ||
         notUpdatingProtectedFields(['userId', 'totalPrice', 'currency', 'bookingDate', 'createdAt']));

      allow delete: if isAdmin();
    }

    // ==================== HOTEL BOOKINGS ====================

    match /hotelBookings/{bookingId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'hotelDetails', 'guestInfo',
                          'bookingDates', 'totalPrice', 'currency']) &&
        hasValidTimestamps() &&
        request.resource.data.totalPrice > 0;

      allow update: if isAdmin() &&
        notUpdatingProtectedFields(['userId', 'bookingDate', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== HOLIDAY PACKAGE BOOKINGS ====================

    match /holidayPackageBookings/{bookingId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'packageDetails', 'travelerInfo',
                          'travelDates', 'totalPrice', 'currency']) &&
        hasValidTimestamps() &&
        request.resource.data.totalPrice > 0;

      allow update: if isAdmin() &&
        notUpdatingProtectedFields(['userId', 'bookingDate', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== VISA APPLICATIONS ====================

    match /visaApplications/{applicationId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'personalInfo', 'contactInfo', 'travelDetails', 'status']) &&
        request.resource.data.status == 'submitted' &&
        hasValidTimestamps();

      allow update: if isAdmin() &&
        notUpdatingProtectedFields(['userId', 'submittedAt', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== STUDY ABROAD APPLICATIONS ====================

    match /applications/{applicationId} {
      allow read: if isOwnerOrAdmin(resource.data.applicant.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.applicant.userId == request.auth.uid &&
        hasRequiredFields(['applicant', 'university', 'program', 'workflow', 'payment']) &&
        request.resource.data.workflow.status in ['draft', 'submitted'] &&
        hasValidTimestamps();

      allow update: if isOwnerOrAdmin(resource.data.applicant.userId) &&
        // Users can only update draft applications, admins can update all
        (isAdmin() || resource.data.workflow.status == 'draft') &&
        notUpdatingProtectedFields(['applicant.userId', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== LEGACY STUDY ABROAD APPLICATIONS ====================

    match /studyAbroadApplications/{applicationId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasValidTimestamps();

      allow update: if isAdmin() &&
        notUpdatingProtectedFields(['userId', 'submittedAt', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== UNIVERSITIES ====================

    match /universities/{universityId} {
      allow read: if true; // Public read

      allow write: if isAdmin() &&
        hasRequiredFields(['basicInfo', 'academics', 'settings']) &&
        hasValidTimestamps();
    }

    // ==================== STUDY ABROAD PROGRAMS ====================

    match /studyAbroadPrograms/{programId} {
      allow read: if true; // Public read

      allow write: if isAdmin() &&
        hasRequiredFields(['basicInfo', 'academics', 'settings']) &&
        hasValidTimestamps();
    }

    // ==================== USERS ====================

    match /users/{userId} {
      allow read: if isOwnerOrAdmin(userId);

      allow create: if isAuthenticated() &&
        userId == request.auth.uid &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.isAdmin == false && // Can't self-grant admin
        hasValidTimestamps();

      allow update: if isOwnerOrAdmin(userId) &&
        // Users can't grant themselves admin, only admins can modify admin status
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['isAdmin', 'isDisabled']) ||
         isAdmin()) &&
        notUpdatingProtectedFields(['uid', 'createdAt']);

      allow delete: if isAdmin();
    }

    // ==================== PRICE ALERTS ====================

    match /priceAlerts/{alertId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'email', 'route', 'targetPrice', 'currency']) &&
        request.resource.data.targetPrice > 0;

      allow update: if isOwnerOrAdmin(resource.data.userId) &&
        notUpdatingProtectedFields(['userId', 'createdAt']);

      allow delete: if isOwnerOrAdmin(resource.data.userId);
    }

    // ==================== NOTIFICATION SUBSCRIPTIONS ====================

    match /notification-subscriptions/{subscriptionId} {
      allow read: if isOwnerOrAdmin(resource.data.userId);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid &&
        hasRequiredFields(['userId', 'endpoint', 'keys']);

      allow update: if isOwnerOrAdmin(resource.data.userId) &&
        notUpdatingProtectedFields(['userId', 'createdAt']);

      allow delete: if isOwnerOrAdmin(resource.data.userId);
    }

    // ==================== NOTIFICATION PREFERENCES ====================

    match /notification-preferences/{userId} {
      allow read: if isOwnerOrAdmin(userId);

      allow create: if isAuthenticated() &&
        userId == request.auth.uid &&
        request.resource.data.userId == request.auth.uid;

      allow update: if isOwnerOrAdmin(userId) &&
        notUpdatingProtectedFields(['userId', 'createdAt']);

      allow delete: if isOwnerOrAdmin(userId);
    }

    // ==================== SPECIAL OFFERS ====================

    match /specialOffers/{offerId} {
      allow read: if true; // Public read

      allow write: if isAdmin() &&
        hasValidTimestamps();
    }

    // ==================== TOP DEALS ====================

    match /topDeals/{dealId} {
      allow read: if true; // Public read

      allow write: if isAdmin() &&
        hasValidTimestamps();
    }
  }
}